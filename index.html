<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PC情報をRequestBinに送信</title>
  <style>
    #GeoIP-ipinfo, #GeoIP-ipapi {
      display: none;
    }
  </style>
</head>
<body>
  <h1>PC情報を送信しています。。。</h1>
  <div id="GeoIP-ipinfo"></div>
  <div id="GeoIP-ipapi"></div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      function collectPCInfo() {
        const pcInfo = {
          userAgent: navigator.userAgent,
          language: navigator.language,
          platform: navigator.platform,
          cookieEnabled: navigator.cookieEnabled,
          screenWidth: screen.width,
          screenHeight: screen.height,
          windowInnerWidth: window.innerWidth,
          windowInnerHeight: window.innerHeight,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          location: {}
        };

        if (confirm('位置情報が送信されますがよろしいですか？')) {
          document.querySelector('h1').textContent = 'PC情報を送信しています。。。';
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
              pcInfo.location.latitude = position.coords.latitude;
              pcInfo.location.longitude = position.coords.longitude;
              fetchIPInfo(pcInfo);
            }, function() {
              fetchIPInfo(pcInfo);
            });
          } else {
            fetchIPInfo(pcInfo);
          }
        } else {
          document.querySelector('h1').textContent = '位置情報の送信がキャンセルされました。';
        }
      }

      async function sendData(pcInfo) {
        try {
          await fetch('https://enikio9fskusg.x.pipedream.net/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(pcInfo)
          });
          console.log('データが送信されました:', pcInfo);
          document.querySelector('h1').textContent = 'データの送信に成功しました。';
        } catch (error) {
          console.error('データ送信中にエラーが発生しました:', error);
          document.querySelector('h1').textContent = 'データ送信中にエラーが発生しました。';
        }
      }

      async function fetchIPInfo(pcInfo) {
        try {
          const [ipinfoResponse, ipapiResponse] = await Promise.all([
            fetch('https://ipinfo.io/json'),
            fetch('https://ipapi.co/json')
          ]);

          const ipinfoData = await ipinfoResponse.json();
          const ipapiData = await ipapiResponse.json();

          pcInfo.ipinfo = ipinfoData;
          pcInfo.ipapi = ipapiData;

          document.getElementById('GeoIP-ipinfo').textContent = JSON.stringify(ipinfoData);
          document.getElementById('GeoIP-ipapi').textContent = JSON.stringify(ipapiData);

          if (!pcInfo.location.latitude && !pcInfo.location.longitude) {
            if (ipinfoData.loc) {
              [pcInfo.location.latitude, pcInfo.location.longitude] = ipinfoData.loc.split(',');
            } else if (ipapiData.latitude && ipapiData.longitude) {
              pcInfo.location.latitude = ipapiData.latitude;
              pcInfo.location.longitude = ipapiData.longitude;
            }
          }

          sendData(pcInfo);
        } catch (error) {
          console.error('IP情報取得中にエラーが発生しました:', error);
          document.querySelector('h1').textContent = 'IP情報取得中にエラーが発生しました。';
        }
      }

      collectPCInfo();
    });
  </script>
</body>
</html>
